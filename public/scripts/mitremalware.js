$(document).on({
  ajaxStart: function () {
    $("body").addClass("loading");
  },
  ajaxStop: function () {
    $("body").removeClass("loading");
  },
});
const limit = 10;
var totatEventIds = [];
var page = 0;
var malwareQuery = null;
var nextPage = function () {
  page = page + 1;
  updateEventTable();
};

var previousPage = function () {
  if (page !== 0) {
    page = page - 1;
    updateEventTable();
  }
};
var searchData = function () {
  page = 0;
  malwareQuery = $("#searchbox").val();
  updateEventTable();
};

var updateEventTable = function () {
  $.ajax({
    url: "https://localhost:3000/ms/mitremalware/info/v1",
    type: "POST",
    data: {
      start: page * limit,
      limit: limit,
      malwareQuery: malwareQuery ? malwareQuery : null,
    },
    success: function (response) {
      var trHTML = "";
      $.each(response, function (i, item) {
        trHTML +=
          '<tr class="removeable event-row" event_id =' +
          item.id +
          "><td>" +
          item.id +
          "</td><td>" +
          item.labels.join(", ") +
          "</td><td>" +
          item.malware_category +
          "</td><td>" +
          item.name +
          "</td><td>" +
          item.type +
          "</td><td>" +
          item.description +
          "</td><td>" +
          item.x_mitre_version +
          "</td><td>" +
          item.modified +
          "</td><td>" +
          item.created +
          " </td> <td>" +
          '<button style="background-color: #008CBA;border: none;color:#fff;padding: 15px 32px;text-align: center;text-decoration: none;display: inline-block;font-size: 16px;"><a href="#" class="btn mitre-selector" event_id =' +
          item.id +
          ">View</a> </button>" +
          " </td></tr>";
      });
      $(".removeable").remove();
      if (response.length > 0) {
        //page += 1;

        $("#records_table").append(trHTML);
      }
      $(".mitre-selector").on("click", function () {
        window.open(
          window.location.origin +
            "/malwaredrilldown.html?id=" +
            this.getAttribute("event_id"),
          "_blank"
        );
      });
    },
  });
};

$(document).ready(function () {
  updateEventTable();
  $("#nextTable").on("click", function () {
    nextPage();
  });
  $("#previousTable").on("click", function () {
    previousPage();
  });
  $("#search").on("click", function () {
    searchData();
  });
});
