$(document).on({
  ajaxStart: function () {
    $("body").addClass("loading");
  },
  ajaxStop: function () {
    $("body").removeClass("loading");
  },
});
const limit = 10;
var totatEventIds = [];
var page = 0;
var malwareQuery = null;
var nextPage = function () {
  page = page + 1;
  updateEventTable();
};

var previousPage = function () {
  if (page !== 0) {
    page = page - 1;
    updateEventTable();
  }
};
var searchData = function () {
  page = 0;
  malwareQuery = $("#searchbox").val();
  updateEventTable();
};
var updateEventTable = function () {
  $.ajax({
    url: "https://localhost:3000/ms/malware/info/v1",
    type: "POST",
    data: {
      start: page * limit,
      limit: limit,
      malwareQuery: malwareQuery ? malwareQuery : null,
    },
    success: function (response) {
      var trHTML = "";
      $.each(response, function (i, item) {
        trHTML +=
          '<tr class="removeable event-row" event_id =' +
          item.file_name +
          "><td>" +
          item.file_name +
          "</td><td>" +
          item.file_type +
          "</td><td>" +
          item.file_size +
          "</td><td>" +
          (item.first_seen && item.first_seen !== null
            ? item.first_seen
            : "-") +
          "</td><td>" +
          (item.last_seen && item.last_seen !== null ? item.last_seen : "-") +
          "</td><td>" +
          item.tags.join(",") +
          "</td><td>" +
          (item.intelligence.clamav ? item.intelligence.clamav : "-") +
          "</td><td>" +
          item.intelligence.downloads +
          " </td><td>" +
          item.intelligence.uploads +
          " </td><td>" +
          (item.signature ? item.signature : "-") +
          " </td><td>" +
          item.reporter +
          " </td><td> " +
          '<a target="_blank" data-target="myModal" class="btn modal-trigger" sha256_hash="' +
          item.sha256_hash +
          '" sha3_384_hash="' +
          item.sha3_384_hash +
          '" sha1_hash="' +
          item.sha1_hash +
          '" md5_hash="' +
          item.md5_hash +
          '">View</a>' +
          "</td>" +
          "</tr>";
      });
      $(".removeable").remove();

      if (response.length > 0) {
        $("#records_table").append(trHTML);
      }
      $('.modal-trigger').on("click", function () {
        $('#sha256_hash').text(($(this).attr('sha256_hash'))?$(this).attr('sha256_hash'):' - ');
        $('#sha3_384_hash').text(($(this).attr('sha3_384_hash'))?$(this).attr('sha3_384_hash'):' - ');
        //$('#sha3_384_hash').text(($(this).attr('sha3_384_hash'))?$(this).attr('sha3_384_hash'):' - ');
        $('#sha1_hash').text(($(this).attr('sha1_hash'))?$(this).attr('sha1_hash'):' - ');
        $('#md5_hash').text(($(this).attr('md5_hash'))?$(this).attr('md5_hash'):' - ');
      });
    },
  });
};

$(document).ready(function () {
  updateEventTable();
  $("#myModal").modal();
  $("#nextTable").on("click", function () {
    nextPage();
  });
  $("#previousTable").on("click", function () {
    previousPage();
  });
  $("#search").on("click", function () {
    searchData();
  });
});
